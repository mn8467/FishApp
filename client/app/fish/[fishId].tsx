import React, { useEffect, useState } from "react";
import {
  View,
  Text,
  Image,
  TouchableOpacity,
  ScrollView,
  ActivityIndicator,
  DimensionValue,
} from "react-native";
import { Ionicons } from "@expo/vector-icons";
import { styles } from "../../components/fishdetailstyle";
import axios from "axios";
import { useLocalSearchParams } from "expo-router";

const CURRENT_HOST = process.env.EXPO_PUBLIC_CURRENT_HOST;

// üéØ ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î†§Ïò§Îäî Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ
interface Fish {
  fishId: number;
  fishName: string;
  familyName: string;
  habitat: string;
  bodyLength: string;
  description: string;
  imageUrl: string;
  totalStats: number;
  hp: number;
  hpDesc: string;
  attack: number;
  attackDesc: string;
  defense: number;
  defenseDesc: string;
  special: number;
  specialDesc: string;
  speed: number;
  speedDesc: string;
}

const STAT_MAX = 200;
const TOTAL_MAX = 1000;
// [CHANGED] ÎùºÎ≤® ÏòÅÏó≠ ÎÑàÎπÑ(ÏïÑÎûò desc Îì§Ïó¨Ïì∞Í∏∞ÏóêÎèÑ ÏÇ¨Ïö©). ÎÑà Ïä§ÌÉÄÏùºÏóê ÎßûÏ∂∞ 80~88Î°ú Ï°∞Ï†à Í∞ÄÎä•.
const LABEL_WIDTH = 88; 

const clamp = (n: number, min = 0, max = STAT_MAX): number =>
  Math.max(min, Math.min(max, n));

const toWidthPct = (n: number): DimensionValue =>
  `${(clamp(n) / STAT_MAX) * 100}%`;

const toTotalPct = (n: number): DimensionValue =>
  `${(Math.max(0, Math.min(TOTAL_MAX, n)) / TOTAL_MAX) * 100}%`;

export default function FishDetailScreen() {
  const [activeTab, setActiveTab] = useState<"info" | "disease">("info");
  const { fishId } = useLocalSearchParams<{ fishId?: string }>();
  const [fish, setFish] = useState<Fish | null>(null);
  const [loading, setLoading] = useState(true);

  // [CHANGED] Ï≤¥Î†•(? ÏïÑÏù¥ÏΩò) ÏÑ§Î™Ö ÌÜ†Í∏Ä ÏÉÅÌÉú
  const [showHpInfo, setShowHpInfo] = useState(false);
  const [showAttackInfo, setShowAttackInfo] = useState(false);
  const [showDefenceInfo, setShowDefenceInfo] = useState(false);
  const [showSpecialInfo, setShowSpecialInfo] = useState(false);
  const [showSpeedInfo, setShowSpeedInfo] = useState(false);


  useEffect(() => {
    const fetchFish = async () => {
      try {
        const res = await axios.get<Fish>(
          `http://${CURRENT_HOST}:8080/api/fish/${fishId || 1}`
        );
        setFish(res.data);
      } catch (err) {
        console.error("üêü Error fetching fish info:", err);
      } finally {
        setLoading(false);
      }
    };
    fetchFish();
  }, [fishId]);

  if (loading) {
    return (
      <View style={[styles.container, { alignItems: "center", justifyContent: "center" }]}>
        <ActivityIndicator size="large" color="#4BA3C3" />
        <Text>Î∂àÎü¨Ïò§Îäî Ï§ë...</Text>
      </View>
    );
  }

  if (!fish) {
    return (
      <View style={[styles.container, { alignItems: "center", justifyContent: "center" }]}>
        <Text>Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</Text>
      </View>
    );
  }

  return (
    <ScrollView style={styles.container}>
      {/* ÏÉÅÎã® Ïù¥ÎØ∏ÏßÄ */}
      <View style={styles.imageContainer}>
        <Image source={{ uri: fish.imageUrl }} style={styles.image} />
        <TouchableOpacity style={styles.likeButton}>
          <Ionicons name="heart-outline" size={28} color="#ff4d4d" />
        </TouchableOpacity>
      </View>

      {/* Ïù¥Î¶Ñ */}
      <Text style={styles.name}>{fish.fishName}</Text>

      {/* ÌÉ≠ Î©îÎâ¥ */}
      <View style={styles.tabContainer}>
        <TouchableOpacity
          style={[styles.tabButton, activeTab === "info" && styles.activeTab]}
          onPress={() => setActiveTab("info")}
        >
          <Text style={[styles.tabText, activeTab === "info" && styles.activeTabText]}>
            Í∏∞Î≥∏Ï†ïÎ≥¥
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.tabButton, activeTab === "disease" && styles.activeTab]}
          onPress={() => setActiveTab("disease")}
        >
          <Text style={[styles.tabText, activeTab === "disease" && styles.activeTabText]}>
            ÏßàÎ≥ë
          </Text>
        </TouchableOpacity>
      </View>

      {/* ÌÉ≠ ÎÇ¥Ïö© */}
      {activeTab === "info" ? (
        <>
          {/* Ïä§ÌÉØ Î∞î */}
          <View style={styles.statsContainer}>
            {[
              // [CHANGED] hp ÌñâÎßå ? ÏïÑÏù¥ÏΩò/ÏÑ§Î™Ö ÌÜ†Í∏Ä Í∏∞Îä•ÏùÑ Î∂ôÏùº Í±∞Îùº labelÎ°ú ÌåêÎ≥Ñ
              { label: "Ï≤¥Î†•", value: fish.hp, desc: fish.hpDesc },
              { label: "Í≥µÍ≤©Î†•", value: fish.attack, desc: fish.attackDesc },
              { label: "Î∞©Ïñ¥Î†•", value: fish.defense, desc: fish.defenseDesc },
              { label: "ÌäπÏàòÎä•Î†•", value: fish.special, desc: fish.specialDesc },
              { label: "Ïä§ÌîºÎìú", value: fish.speed, desc: fish.speedDesc },
            ].map((stat, idx) => {
              const barWidth: DimensionValue = toWidthPct(stat.value);
              const isHP = stat.label === "Ï≤¥Î†•"; // [CHANGED]
              const isAttack = stat.label === "Í≥µÍ≤©Î†•"; // [CHANGED]
              const isDefense = stat.label === "Î∞©Ïñ¥Î†•"; // [CHANGED]
              const isSpecial = stat.label === "ÌäπÏàòÎä•Î†•"; // [CHANGED]
              const isSpeed = stat.label === "Ïä§ÌîºÎìú"; // [CHANGED]



              return (
                <View key={idx} style={{ marginBottom: isHP && showHpInfo ? 6 : 0 }}>
                  <View style={styles.statRow}>
                    {/* [CHANGED] ÎùºÎ≤® + ? ÏïÑÏù¥ÏΩò Î¨∂Ïñ¥ÏÑú Í∞ôÏùÄ Ï§ÑÏóê Î∞∞Ïπò */}
                    <View style={{ width: LABEL_WIDTH, flexDirection: "row", alignItems: "center" }}>
                      <Text style={styles.statLabel}>{stat.label}</Text>
                      {isHP && (
                        <TouchableOpacity
                          onPress={() => setShowHpInfo((v) => !v)}
                          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
                          style={styles.helpIcon /* [CHANGED] */}
                        >
                          <Ionicons name="help-circle-outline" size={16} color="#888" />
                        </TouchableOpacity>
                      )}
                      {isAttack && (
                        <TouchableOpacity
                          onPress={() => setShowAttackInfo((v) => !v)}
                          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
                          style={styles.helpIcon /* [CHANGED] */}
                        >
                          <Ionicons name="help-circle-outline" size={16} color="#888" />
                        </TouchableOpacity>
                      )}
                      {isDefense && (
                        <TouchableOpacity
                          onPress={() => setShowDefenceInfo((v) => !v)}
                          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
                          style={styles.helpIcon /* [CHANGED] */}
                        >
                          <Ionicons name="help-circle-outline" size={16} color="#888" />
                        </TouchableOpacity>
                      )}
                      {isSpecial && (
                        <TouchableOpacity
                          onPress={() => setShowSpecialInfo((v) => !v)}
                          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
                          style={styles.helpIcon /* [CHANGED] */}
                        >
                          <Ionicons name="help-circle-outline" size={16} color="#888" />
                        </TouchableOpacity>
                      )}
                      {isSpeed && (
                        <TouchableOpacity
                          onPress={() => setShowSpeedInfo((v) => !v)}
                          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
                          style={styles.helpIcon /* [CHANGED] */}
                        >
                          <Ionicons name="help-circle-outline" size={16} color="#888" />
                        </TouchableOpacity>
                      )}
                    </View>

                    <View style={styles.statBarBackground}>
                      <View style={[styles.statBar, { width: barWidth }]} />
                    </View>
                    <Text style={styles.statValue}>{clamp(stat.value)}</Text>
                  </View>

                  {/* [CHANGED] hpDesc ÌÜ†Í∏Ä ÌëúÏãú (ÎùºÎ≤® ÏòÅÏó≠ÎßåÌÅº Îì§Ïó¨Ïì∞Í∏∞) */}
                  {isHP && showHpInfo && (
                    <Text
                      style={{
                        marginLeft: LABEL_WIDTH,
                        marginTop: 4,
                        marginRight: 8,
                        fontSize: 12,
                        color: "#666",
                        lineHeight: 18,
                      }}
                      numberOfLines={4}
                    >
                      {stat.desc}
                    </Text>
                  )}
                  {isAttack && showAttackInfo && (
                    <Text
                      style={{
                        marginLeft: LABEL_WIDTH,
                        marginTop: 4,
                        marginRight: 8,
                        fontSize: 12,
                        color: "#666",
                        lineHeight: 18,
                      }}
                      numberOfLines={4}
                    >
                      {stat.desc}
                    </Text>
                  )}
                  {isDefense && showDefenceInfo && (
                    <Text
                      style={{
                        marginLeft: LABEL_WIDTH,
                        marginTop: 4,
                        marginRight: 8,
                        fontSize: 12,
                        color: "#666",
                        lineHeight: 18,
                      }}
                      numberOfLines={4}
                    >
                      {stat.desc}
                    </Text>
                  )}
                  {isSpecial && showSpecialInfo && (
                    <Text
                      style={{
                        marginLeft: LABEL_WIDTH,
                        marginTop: 4,
                        marginRight: 8,
                        fontSize: 12,
                        color: "#666",
                        lineHeight: 18,
                      }}
                      numberOfLines={4}
                    >
                      {stat.desc}
                    </Text>
                  )}
                  {isSpeed && showSpeedInfo && (
                    <Text
                      style={{
                        marginLeft: LABEL_WIDTH,
                        marginTop: 4,
                        marginRight: 8,
                        fontSize: 12,
                        color: "#666",
                        lineHeight: 18,
                      }}
                      numberOfLines={4}
                    >
                      {stat.desc}
                    </Text>
                  )}
                </View>
              );
            })}
          </View>

          {/* Ï¥ùÌï© Î∞î */}
          <View style={[styles.section, { marginTop: 16 }]}>
            <Text style={styles.sectionTitle}>Ï¥ùÌï©</Text>
            <View style={styles.statRow}>
              <View style={{ width: LABEL_WIDTH }}>
                <Text style={styles.statLabel}>Total</Text>
              </View>
              <View style={styles.statBarBackground}>
                <View style={[styles.statBar, { width: toTotalPct(fish.totalStats) }]} />
              </View>
              <Text style={styles.statValue}>{Math.min(fish.totalStats, TOTAL_MAX)}</Text>
            </View>
          </View>

          {/* ÏÑ§Î™Ö */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>ÏÑ§Î™Ö</Text>
            <Text style={styles.description}>{fish.description}</Text>
          </View>

          {/* Í∏∞Î≥∏ Ï†ïÎ≥¥ */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Í∏∞Î≥∏ Ï†ïÎ≥¥</Text>
            <Text>Í≥ºÎ™Ö: {fish.familyName}</Text>
            <Text>ÏÑúÏãùÏßÄ: {fish.habitat}</Text>
            <Text>Î™∏Í∏∏Ïù¥: {fish.bodyLength}</Text>
          </View>
        </>
      ) : (
        <>
          {/* ÏßàÎ≥ë ÌÉ≠ */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>ÏßàÎ≥ë Ï†ïÎ≥¥</Text>
            <Text style={styles.description}>
              Ïù¥ Ïñ¥Ï¢ÖÏùÄ ÏàòÏò®Ïù¥ ÎÇÆÍ±∞ÎÇò ÌÉÅÌïú Î¨ºÏóêÏÑú ÏßÄÎäêÎü¨ÎØ∏ Î∂ÄÏãùÏ¶ù, Î∞±Ï†êÎ≥ë Îì±Ïù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.
              Ï†ïÍ∏∞Ï†ÅÏù∏ ÏàòÏßà Í¥ÄÎ¶¨ÏôÄ Íπ®ÎÅóÌïú ÌôòÍ≤Ω Ïú†ÏßÄÍ∞Ä Ï§ëÏöîÌï©ÎãàÎã§.
            </Text>
          </View>
        </>
      )}
    </ScrollView>
  );
}
